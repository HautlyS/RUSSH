name: 'Tauri-Unsigned-IPA'
description: 'Build unsigned iOS IPA from Tauri project for Sideloadly'
author: 'HautlyS'

inputs:
  working-directory:
    description: 'Path to Tauri project'
    default: '.'
  rust-targets:
    description: 'Rust targets for iOS'
    default: 'aarch64-apple-ios,aarch64-apple-ios-sim'

outputs:
  ipa-path:
    description: 'Path to the generated IPA'
    value: ${{ steps.package.outputs.ipa-path }}

runs:
  using: "composite"
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ inputs.rust-targets }}

    - name: Install dependencies
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pnpm install

    - name: Init iOS
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: pnpm tauri ios init

    - name: Patch iOS project for release
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        python3 "${{ github.workspace }}/.github/scripts/patch_ios_project.py"

    - name: Build Rust (Release)
      shell: bash
      working-directory: ${{ inputs.working-directory }}/src-tauri
      run: |
        cargo build --release --target aarch64-apple-ios

    - name: Copy Rust library to Xcode project
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        # Ensure directories exist
        mkdir -p src-tauri/gen/apple/Externals/arm64/debug
        mkdir -p src-tauri/gen/apple/Externals/arm64/release
        
        # Find the library
        LIB_FILE="src-tauri/target/aarch64-apple-ios/release/librussh_client.a"
        if [ ! -f "$LIB_FILE" ]; then
          echo "Looking for .a file..."
          LIB_FILE=$(find src-tauri/target/aarch64-apple-ios/release -name "*.a" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ] || [ ! -f "$LIB_FILE" ]; then
          echo "âŒ No .a library found"
          ls -la src-tauri/target/aarch64-apple-ios/release/ || true
          exit 1
        fi
        
        echo "Found library: $LIB_FILE"
        cp "$LIB_FILE" src-tauri/gen/apple/Externals/arm64/debug/libapp.a
        cp "$LIB_FILE" src-tauri/gen/apple/Externals/arm64/release/libapp.a

    - name: Build & Archive (Unsigned)
      shell: bash
      working-directory: ${{ inputs.working-directory }}/src-tauri/gen/apple
      env:
        TAURI_CLI_NO_DEV_SERVER_WAIT: "true"
      run: |
        PROJ=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
        
        if [ -n "$PROJ" ]; then
          BUILD_TYPE="-workspace"
        else
          PROJ=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1)
          BUILD_TYPE="-project"
        fi
        
        SCHEME=$(xcodebuild -list $BUILD_TYPE "$PROJ" 2>/dev/null | awk '/Schemes:/{getline; print; exit}' | xargs)
        
        echo "Building $PROJ with scheme $SCHEME"
        
        # Use the xcconfig generated by the patch script
        XCCONFIG=""
        if [ -f "Release-Unsigned.xcconfig" ]; then
          XCCONFIG="-xcconfig Release-Unsigned.xcconfig"
        fi
        
        xcodebuild archive $BUILD_TYPE "$PROJ" -scheme "$SCHEME" \
          -archivePath app.xcarchive \
          -configuration Release \
          -destination "generic/platform=iOS" \
          $XCCONFIG \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          AD_HOC_CODE_SIGNING_ALLOWED=NO \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES

    - name: Package IPA
      id: package
      shell: bash
      working-directory: ${{ inputs.working-directory }}/src-tauri/gen/apple
      run: |
        cd app.xcarchive/Products
        APP_PATH=$(find Applications -name "*.app" -type d | head -1)
        if [ -z "$APP_PATH" ]; then
             APP_PATH=$(find . -name "*.app" -type d | head -1)
        fi
        
        mkdir Payload
        cp -R "$APP_PATH" Payload/
        zip -r ../unsigned.ipa Payload
        rm -rf Payload
        
        echo "ipa-path=${{ inputs.working-directory }}/src-tauri/gen/apple/app.xcarchive/Products/unsigned.ipa" >> $GITHUB_OUTPUT

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: ${{ inputs.working-directory }}/src-tauri/gen/apple/app.xcarchive/Products/unsigned.ipa
