name: Build Mobile

on:
  workflow_call:
    inputs:
      platform:
        type: string
        default: 'both'
      version:
        type: string
        default: ''
      sign_ios:
        type: boolean
        default: false
    secrets:
      APPLE_CERTIFICATE:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_PROVISIONING_PROFILE:
        required: false
      APPLE_TEAM_ID:
        required: false

jobs:
  ios:
    name: iOS
    if: inputs.platform == 'ios' || inputs.platform == 'both'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-env
        with:
          rust-targets: aarch64-apple-ios,aarch64-apple-ios-sim

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "russh-client/src-tauri -> target"
          key: ios

      - name: Update version
        if: inputs.version != ''
        working-directory: russh-client
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version || true
          sed -i '' 's/^version = ".*"/version = "${{ inputs.version }}"/' src-tauri/Cargo.toml

      - name: Setup signing
        if: inputs.sign_ios
        env:
          CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          # Decode certificate
          echo "$CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          
          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate
          security import $RUNNER_TEMP/certificate.p12 -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision
          
          echo "SIGNING_ENABLED=true" >> $GITHUB_ENV

      - name: Init iOS project
        working-directory: russh-client
        run: pnpm tauri ios init

      - name: Patch Xcode scheme for Release
        working-directory: russh-client/src-tauri/gen/apple
        run: |
          # Find and patch all schemes to use Release configuration
          find . -name "*.xcscheme" -type f | while read scheme; do
            echo "Patching scheme: $scheme"
            # Replace Debug with Release in buildConfiguration
            sed -i '' 's/buildConfiguration = "Debug"/buildConfiguration = "Release"/g' "$scheme"
          done

          # Patch project.pbxproj to force Release configuration in the tauri script
          find . -name "project.pbxproj" -type f | while read pbx; do
            echo "Patching pbxproj: $pbx"
            sed -i '' 's/--configuration \${CONFIGURATION:\?}/--configuration Release/g' "$pbx"
            sed -i '' 's/GCC_PREPROCESSOR_DEFINITIONS:-/IGNORE_GCC_DEFINITIONS:-/g' "$pbx"
          done

      - name: Build frontend
        working-directory: russh-client
        run: pnpm build

      - name: Build Rust for iOS
        working-directory: russh-client
        run: |
          cd src-tauri
          cargo build --release --target aarch64-apple-ios

      - name: Patch tauri.conf.json (Disable devUrl)
        working-directory: russh-client
        run: |
          # Rename devUrl to _devUrl to force tauri-cli to treat this as a production build
          sed -i '' 's/"devUrl"/"_devUrl"/' src-tauri/tauri.conf.json

      - name: Create IPA
        working-directory: russh-client/src-tauri/gen/apple
        env:
          TAURI_CLI_NO_DEV_SERVER_WAIT: "true"
        run: |
          # Find project
          PROJ=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1)
          BUILD_TYPE="-workspace"
          [ -z "$PROJ" ] && { PROJ=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -1); BUILD_TYPE="-project"; }
          [ -z "$PROJ" ] && { echo "No Xcode project found"; exit 1; }
          
          # Get scheme
          SCHEME=$(xcodebuild -list $BUILD_TYPE "$PROJ" 2>/dev/null | awk '/Schemes:/{getline; print; exit}' | xargs)
          [ -z "$SCHEME" ] && { echo "No scheme found"; exit 1; }
          
          echo "Building: $BUILD_TYPE $PROJ -scheme $SCHEME"
          
          if [ "${{ env.SIGNING_ENABLED }}" = "true" ]; then
            # Signed build
            xcodebuild archive $BUILD_TYPE "$PROJ" -scheme "$SCHEME" \
              -archivePath "$GITHUB_WORKSPACE/app.xcarchive" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              DEVELOPMENT_TEAM="housaky" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES
            
            # Export signed IPA
            cat > export.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string>housaky</string>
          </dict>
          </plist>
          EOF
            xcodebuild -exportArchive \
              -archivePath "$GITHUB_WORKSPACE/app.xcarchive" \
              -exportPath "$GITHUB_WORKSPACE" \
              -exportOptionsPlist export.plist
            mv "$GITHUB_WORKSPACE"/*.ipa "$GITHUB_WORKSPACE/RUSSH-ios.ipa"
          else
            # Unsigned build
            xcodebuild archive $BUILD_TYPE "$PROJ" -scheme "$SCHEME" \
              -archivePath "$GITHUB_WORKSPACE/app.xcarchive" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              DEVELOPMENT_TEAM="housaky" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES
            
            cd "$GITHUB_WORKSPACE/app.xcarchive/Products"
            mv Applications Payload
            zip -r "$GITHUB_WORKSPACE/RUSSH-ios-unsigned.ipa" Payload
          fi

      - name: Cleanup signing
        if: always() && env.SIGNING_ENABLED == 'true'
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build.mobileprovision

      - uses: actions/upload-artifact@v4
        with:
          name: mobile-ios
          path: |
            RUSSH-ios.ipa
            RUSSH-ios-unsigned.ipa
          if-no-files-found: warn

  android:
    name: Android
    if: inputs.platform == 'android' || inputs.platform == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-env
        with:
          rust-targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "russh-client/src-tauri -> target"
          key: android

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Update version
        if: inputs.version != ''
        working-directory: russh-client
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version || true
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' src-tauri/Cargo.toml

      - name: Init & Build Android
        working-directory: russh-client
        run: |
          pnpm tauri android init
          pnpm tauri android build --apk

      - uses: actions/upload-artifact@v4
        with:
          name: mobile-android
          path: russh-client/src-tauri/gen/android/app/build/outputs/apk/**/*.apk
          if-no-files-found: warn
