name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: RUSSH v${{ steps.get_version.outputs.version }}
          draft: true
          prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') }}
          generate_release_notes: true

  build-desktop:
    name: Release Desktop (${{ matrix.target }})
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact_suffix: linux-x64
          - platform: macos-14
            target: aarch64-apple-darwin
            artifact_suffix: macos-arm64
          - platform: macos-13
            target: x86_64-apple-darwin
            artifact_suffix: macos-x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_suffix: windows-x64
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install Linux dependencies
        if: contains(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Install frontend dependencies
        working-directory: russh-client
        run: pnpm install --frozen-lockfile
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      
      - name: Update version
        working-directory: russh-client
        run: |
          # Update package.json version
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version || true
          # Update Cargo.toml version
          sed -i.bak 's/^version = ".*"/version = "${{ needs.create-release.outputs.version }}"/' src-tauri/Cargo.toml || true
          # Update tauri.conf.json version
          sed -i.bak 's/"version": ".*"/"version": "${{ needs.create-release.outputs.version }}"/' src-tauri/tauri.conf.json || true
      
      - name: Build Tauri app
        working-directory: russh-client
        run: pnpm tauri build --target ${{ matrix.target }}
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.deb
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.AppImage
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.dmg
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.app.tar.gz
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.msi
            russh-client/src-tauri/target/${{ matrix.target }}/release/bundle/**/*.exe

  build-ios:
    name: Release iOS (Unsigned IPA)
    needs: create-release
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Install frontend dependencies
        working-directory: russh-client
        run: pnpm install --frozen-lockfile
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: ios-release
      
      - name: Update version
        working-directory: russh-client
        run: |
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version || true
          sed -i '' 's/^version = ".*"/version = "${{ needs.create-release.outputs.version }}"/' src-tauri/Cargo.toml || true
          sed -i '' 's/"version": ".*"/"version": "${{ needs.create-release.outputs.version }}"/' src-tauri/tauri.conf.json || true
      
      - name: Initialize iOS project
        working-directory: russh-client
        run: pnpm tauri ios init || true
      
      - name: Build iOS
        working-directory: russh-client
        run: pnpm tauri ios build --release
        continue-on-error: true
      
      - name: Build unsigned xcarchive
        working-directory: russh-client/src-tauri/gen/apple
        run: |
          XCODEPROJ=$(find . -name "*.xcodeproj" -type d | head -1)
          XCWORKSPACE=$(find . -name "*.xcworkspace" -type d | head -1)
          
          if [ -n "$XCODEPROJ" ]; then
            SCHEME=$(xcodebuild -list -project "$XCODEPROJ" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
            xcodebuild archive \
              -project "$XCODEPROJ" \
              -scheme "$SCHEME" \
              -archivePath "${{ github.workspace }}/RUSSH.xcarchive" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO || true
          elif [ -n "$XCWORKSPACE" ]; then
            SCHEME=$(xcodebuild -list -workspace "$XCWORKSPACE" 2>/dev/null | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -1 | xargs)
            xcodebuild archive \
              -workspace "$XCWORKSPACE" \
              -scheme "$SCHEME" \
              -archivePath "${{ github.workspace }}/RUSSH.xcarchive" \
              -configuration Release \
              -destination "generic/platform=iOS" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO || true
          fi
      
      - name: Create unsigned IPA
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          if [ -d "RUSSH.xcarchive/Products" ]; then
            cd RUSSH.xcarchive/Products
            mv Applications Payload 2>/dev/null || true
            if [ -d "Payload" ]; then
              zip -r "${{ github.workspace }}/RUSSH-${VERSION}-ios-unsigned.ipa" Payload
            fi
          fi
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            RUSSH-*-ios-unsigned.ipa

  build-android:
    name: Release Android (APK)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
      
      - name: Install frontend dependencies
        working-directory: russh-client
        run: pnpm install --frozen-lockfile
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: android-release
      
      - name: Update version
        working-directory: russh-client
        run: |
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version || true
          sed -i 's/^version = ".*"/version = "${{ needs.create-release.outputs.version }}"/' src-tauri/Cargo.toml || true
          sed -i 's/"version": ".*"/"version": "${{ needs.create-release.outputs.version }}"/' src-tauri/tauri.conf.json || true
      
      - name: Initialize Android project
        working-directory: russh-client
        run: pnpm tauri android init || true
      
      - name: Build Android APK
        working-directory: russh-client
        run: pnpm tauri android build --apk
        continue-on-error: true
      
      - name: Sign APK (if keystore provided)
        if: ${{ env.HAS_KEYSTORE == 'true' }}
        env:
          HAS_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          find russh-client -name "*-unsigned.apk" -exec \
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore keystore.jks \
            -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            {} "${{ secrets.ANDROID_KEY_ALIAS }}" \;
          rm keystore.jks
      
      - name: Rename APKs
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          find russh-client -name "*.apk" -type f | while read apk; do
            dir=$(dirname "$apk")
            base=$(basename "$apk" .apk)
            mv "$apk" "$dir/RUSSH-${VERSION}-android-${base}.apk" 2>/dev/null || true
          done
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            russh-client/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

  publish-release:
    name: Publish Release
    needs: [create-release, build-desktop, build-ios, build-android]
    runs-on: ubuntu-latest
    if: always() && needs.create-release.result == 'success'
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          draft: false
        if: ${{ !contains(needs.create-release.outputs.version, 'alpha') && !contains(needs.create-release.outputs.version, 'beta') }}
